<!DOCTYPE html>
<html>
<head>
    <title>Live Casting</title>
    <!-- Include Firebase libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>
    <!-- <span>
        <h3>Local Stream</h3>
        <video id="webcamVideo" autoplay playsinline></video>
      </span> -->
    <script>

    // Parse the URL query parameters
        const queryParams = new URLSearchParams(window.location.search);
        const predefinedID = queryParams.get('predefinedID') || 'defaultID';
        const firebaseConfig = {
            apiKey: "AIzaSyCwj4UmuEi1JBjyqyGXABfUd8K1tMFkgHM",
            authDomain: "web-agent-625d0.firebaseapp.com",
            projectId: "web-agent-625d0",
            storageBucket: "web-agent-625d0.appspot.com",
            messagingSenderId: "666488380683",
            appId: "1:666488380683:web:e116f264dc04e43539160e",
            measurementId: "G-Q8MDFJ0SXC"
        };

        if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();

        const servers = {
        iceServers: [
            {
            urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'],
            },
        ],
        iceCandidatePoolSize: 10,
        };


        const pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;

        const startStream = async () => {
            localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
            remoteStream = new MediaStream();

            // Push tracks from local stream to peer connection
            localStream.getTracks().forEach((track) => {
                console.log(`Adding local track: ${track.kind}`);
                pc.addTrack(track, localStream);
            });

            // Pull tracks from remote stream, add to video stream
            pc.ontrack = (event) => {
                event.streams[0].getTracks().forEach((track) => {
                console.log(`Adding track to remoteStream: ${track.kind}`);
                remoteStream.addTrack(track);
                });
            };

            // Reference Firestore collections for signaling
            const callDoc = firestore.collection('calls').doc(predefinedID);
            console.log(`Firestore document reference created for ID: ${predefinedID}`);

            const offerCandidates = callDoc.collection('offerCandidates');
            const answerCandidates = callDoc.collection('answerCandidates');
            console.log("Firestore collections for offerCandidates and answerCandidates initialized.");


            // Get candidates for caller, save to db
            pc.onicecandidate = (event) => {
                console.log("New ICE candidate discovered, saving to Firestore.");
                console.log(event.candidate.toJSON());
                event.candidate && offerCandidates.add(event.candidate.toJSON());
            };

            // Create offer
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            const offer = {
                sdp: offerDescription.sdp,
                type: offerDescription.type,
            };

            await callDoc.set({ offer });

            // Listen for remote answer
            callDoc.onSnapshot((snapshot) => {
                console.log("Answer found and set as remote description.");
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                const answerDescription = new RTCSessionDescription(data.answer);
                pc.setRemoteDescription(answerDescription);
                }
            });

            answerCandidates.onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    console.log("New ICE candidate found, adding to peer connection.");
                    const candidate = new RTCIceCandidate(change.doc.data());
                    pc.addIceCandidate(candidate);
                }
                });
            });
        };
        
        startStream();
        
    </script>
</body>
</html>